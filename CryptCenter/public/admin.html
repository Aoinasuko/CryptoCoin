<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒŠã‚¹ã‚³ã‚¤ãƒ³ ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #f0f0f0; padding: 20px; text-align: center; color: #333; }
        .container { max-width: 850px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 20px; font-size: 24px; }
        .step { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; text-align: left; }
        .step h3 { margin-top: 0; border-left: 5px solid #6200ea; padding-left: 10px; }
        input, button { padding: 12px; margin: 5px 0; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { background: #6200ea; color: white; border: none; cursor: pointer; border-radius: 6px; font-weight: bold; transition: background 0.3s; }
        button:hover { background: #3700b3; }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        #canvas-container { margin-top: 20px; text-align: center; background: #222; padding: 20px; border-radius: 8px; }
        canvas { box-shadow: 0 4px 10px rgba(0,0,0,0.5); max-width: 100%; height: auto; }
        .hidden { display: none; }
        .input-group { margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ† ãƒŠã‚¹ã‚³ã‚¤ãƒ³ ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆ</h1>
    <p style="font-size:14px; color:red;">â€»å¿…ãš http://localhost:3000/admin_tool.html ã§é–‹ã„ã¦ãã ã•ã„</p>

    <div class="step">
        <h3>1. ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆè¨­å®š</h3>
        <div class="input-group">
            <label>ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
            <input type="text" id="contractAddress" placeholder="0x..." />
        </div>
        <button onclick="connectWallet()">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š</button>
        <p id="status" style="margin-top:5px; font-size:14px; color:#666;">æœªæ¥ç¶š</p>
    </div>

    <div class="step">
        <h3>2. ãƒˆãƒ¼ã‚¯ãƒ³åœ¨åº«ç™ºè¡Œ (Mint)</h3>
        <p style="font-size:14px; color:#666;">é…å¸ƒç”¨ã«ã€ã¾ãšè‡ªåˆ†ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
        <button onclick="mintToken()">è‡ªåˆ†å®›ã¦ã«1æšç™ºè¡Œ</button>
        <p id="mintStatus" style="font-weight:bold;"></p>
    </div>

    <div class="step">
        <h3>3. ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ç”»åƒç”Ÿæˆ</h3>
        <div class="input-group">
            <label>QRã‚³ãƒ¼ãƒ‰ã®URL (ã‚µãƒ¼ãƒãƒ¼ã§ç™ºè¡Œã—ãŸURL):</label>
            <input type="text" id="qrUrl" placeholder="ä¾‹: http://.../index.html?code=abc..." />
        </div>
        <div class="input-group">
            <label>ã‚«ãƒ¼ãƒ‰ã«è¨˜è¼‰ã™ã‚‹ID:</label>
            <input type="text" id="cardId" placeholder="ä¾‹: #001" />
        </div>
        <button onclick="generateCard()">ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ç”Ÿæˆ</button>
    </div>

    <div id="canvas-container" class="hidden">
        <h3 style="color:white; margin-top:0;">å®Œæˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <canvas id="cardCanvas" width="650" height="400"></canvas>
        <br><br>
        <button onclick="downloadCard()" style="background:#00c853;">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (PNG)</button>
    </div>
    
    <div id="qrcode" style="display:none;"></div>
</div>

<script>
    let provider, signer, contract;
    const abi = ["function safeMint(address to) public"];

    // 1. ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šï¼ˆä¿®æ­£ç‰ˆï¼‰
    async function connectWallet() {
        // window.ethereumãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (typeof window.ethereum === 'undefined') {
            return alert("MetaMaskãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚PCã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }

        try {
            // Ethersãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®åˆæœŸåŒ–
            provider = new ethers.BrowserProvider(window.ethereum);
            
            // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¦æ±‚
            await provider.send("eth_requestAccounts", []);
            
            signer = await provider.getSigner();
            const address = await signer.getAddress();
            
            document.getElementById("status").innerText = "æ¥ç¶šä¸­: " + address;
            document.getElementById("status").style.color = "green";
        } catch (e) {
            console.error(e);
            alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + (e.reason || e.message));
        }
    }

    // 2. Mintå®Ÿè¡Œ
    async function mintToken() {
        const addressInput = document.getElementById("contractAddress").value;
        if (!signer) return alert("å…ˆã«ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„");
        
        try {
            document.getElementById("mintStatus").innerText = "å‡¦ç†ä¸­...";
            contract = new ethers.Contract(addressInput, abi, signer);
            const myAddress = await signer.getAddress();
            const tx = await contract.safeMint(myAddress);
            await tx.wait();
            document.getElementById("mintStatus").innerText = "ç™ºè¡ŒæˆåŠŸï¼";
            document.getElementById("mintStatus").style.color = "green";
            alert("ç™ºè¡Œå®Œäº†ï¼");
        } catch (e) {
            console.error(e);
            alert("ç™ºè¡Œã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    }

    // 3. ç”»åƒç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç”»åƒèª­ã¿è¾¼ã¿å¯¾å¿œç‰ˆï¼‰
    function generateCard() {
        const url = document.getElementById("qrUrl").value;
        const idText = document.getElementById("cardId").value || "SAMPLE";
        
        if(!url) return alert("URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        // QRç”Ÿæˆ
        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
            text: url,
            width: 150,
            height: 150,
            correctLevel: QRCode.CorrectLevel.M // QRã®å¯†åº¦ï¼ˆM=æ¨™æº–ï¼‰
        });

        // ç”»åƒã®èª­ã¿è¾¼ã¿å‡¦ç†
        const bgImg = new Image();
        bgImg.src = "./background.png"; // åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã®ç”»åƒã‚’æŒ‡å®š
        
        // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«æç”»é–‹å§‹
        bgImg.onload = () => {
            drawCanvas(bgImg, qrContainer, idText);
        };

        bgImg.onerror = () => {
            alert("ã‚¨ãƒ©ãƒ¼: 'background.png' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã„ã¦ãã ã•ã„ã€‚");
            // ç”»åƒãŒãªã„å ´åˆã¯é»’èƒŒæ™¯ã§æç”»ã‚’ç¶šè¡Œ
            drawCanvas(null, qrContainer, idText);
        };
    }

    // æç”»ã®æœ¬ä½“
    function drawCanvas(img, qrContainer, idText) {
        const canvas = document.getElementById("cardCanvas");
        const ctx = canvas.getContext("2d");
        const qrImg = qrContainer.querySelector("img");

        if(!qrImg.src) return alert("QRç”Ÿæˆå¾…æ©Ÿä¸­...ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ãã ã•ã„");

        // 1. èƒŒæ™¯æç”»
        if (img) {
            ctx.drawImage(img, 0, 0, 650, 400);
        } else {
            ctx.fillStyle = "#1a1a1a";
            ctx.fillRect(0, 0, 650, 400);
        }

        // 2. æ–‡å­—ã®è¦‹ã‚„ã™ã•ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®åŠé€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰
        // å·¦å´ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã ã‘å°‘ã—æš—ãã™ã‚‹
        ctx.fillStyle = "rgba(0, 0, 0, 0.6)"; 
        ctx.fillRect(20, 20, 350, 60); 
        // å³å´ã®QRã‚¨ãƒªã‚¢ã®ä¸‹åœ°ï¼ˆç™½ï¼‰
        ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
        ctx.fillRect(285, 100, 130, 130);

        // 3. ãƒ†ã‚­ã‚¹ãƒˆæç”»
        ctx.fillStyle = "white";
        ctx.textAlign = "left";
        ctx.textBaseline = "top";

        // èª¬æ˜æ–‡
        ctx.font = "10px sans-serif";
        ctx.fillStyle = "#e0e0e0";
        const lineHeight = 16;
        let startY = 30;

        ctx.fillText("ã“ã‚Œã¯MetaMaskç­‰ã§æš—å·è¨˜å¿µé€šè²¨(ãƒˆãƒ¼ã‚¯ãƒ³)ã‚’ç²å¾—ã§ãã‚‹QRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚", 30, startY);
        ctx.fillText("é‡‘éŠ­çš„ä¾¡å€¤ã¯ç„¡ãã€æ›é‡‘ã‚„ä»–ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã®äº¤æ›ã¯ã§ãã¾ã›ã‚“ã€‚", 30, startY + lineHeight);

        // æ³¨æ„æ›¸ã
        ctx.fillStyle = "#ffaaaa"; 
        ctx.font = "bold 10px sans-serif";
        ctx.fillText("â€»ãƒˆãƒ¼ã‚¯ãƒ³ã¯åˆ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å‹•ã‹ã›ãªã„ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚", 30, startY + (lineHeight * 2));

        // 4. QRã‚³ãƒ¼ãƒ‰é…ç½®
        ctx.drawImage(qrImg, 300, 115, 100, 100);

        // 5. IDæç”» (å³ä¸‹)
        // èƒŒæ™¯ç”»åƒã«ã‚ˆã£ã¦ã¯æ–‡å­—ãŒè¦‹ãˆã«ãã„ã®ã§ã€æ–‡å­—ã«ç¸å–ã‚Šã‚’ã¤ã‘ã‚‹
        ctx.textAlign = "middle";
        ctx.font = "bold 18px sans-serif";
        
        // ç¸å–ã‚Š
        ctx.strokeStyle = "black";
        ctx.lineWidth = 4;
        ctx.strokeText(idText, 520, 360);
        
        // æœ¬ä½“
        ctx.fillStyle = "white"; // ã‚´ãƒ¼ãƒ«ãƒ‰
        ctx.fillText(idText, 520, 360);

        // è¡¨ç¤º
        document.getElementById("canvas-container").classList.remove("hidden");
    }

    function downloadCard() {
        const canvas = document.getElementById("cardCanvas");
        const link = document.createElement("a");
        const id = document.getElementById("cardId").value || "card";
        link.download = `nasu_gift_${id}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
</script>

</body>
</html>